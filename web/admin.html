<html>
<head>
    <title>Admin</title>
    <style type="text/css">
        ul.list {
            width:1200px;
            margin-bottom:20px;
            overflow:hidden;
            border-top:1px solid #ccc;
        }

        ul.list li {
            width:10%;
            line-height:1.5em;
            border-bottom:1px solid #ccc;
            float:left;
            display:inline;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
    <script>
        var User = Backbone.Model.extend({
            defaults: function() {
                return {
                    id: '',
                    queues: [],
                    isNew: false,
                    isDeleted: false
                };
            }
        });

        var UserList = Backbone.Collection.extend({
            model: User
        });

        var UserView = Backbone.View.extend({
            tagName:  "li",

            events: {
            },

            initialize: function() {
                this.model.bind('all', this.render, this);
                this.model.bind('destroy', this.remove, this);
            },

            render: function() {
                this.$el.html(this.model.get('id'));
                this.$el.css('color', '');
                if(this.model.get('isNew')) this.$el.css('color', 'green');
                if(this.model.get('isDeleted')) this.$el.css('color', 'red');
                return this;
            }
        });

        var UserListView = Backbone.View.extend({
            initialize: function() {
                this.collection.bind('add', this.renderAdd, this);
            },

            renderAdd: function(model) {
                var view = new UserView({model: model});
                this.$el.append(view.render().el);
            },

            processData: function(userIds) {
                var keys = Object.keys(userIds);
                var deletedUsers = this.collection.where({isDeleted: true});
                var newUsers = this.collection.where({isNew: true});

                deletedUsers.forEach(this.delete, this);
                newUsers.forEach(this.cleanNew, this);

                this.collection.forEach(function(model) {
                    if(keys.indexOf(model.get('id')) === -1) {
                        model.set({isDeleted: true});
                    }
                }, this);
                keys.forEach(function(id) {
                    if(!this.collection.get(id)) {
                        this.collection.add(new User({id: id, isNew: true}));
                    }
                }, this);
            },

            delete: function(model) {
                this.collection.remove(model);
                model.destroy();
            },

            cleanNew: function(model) {
                model.set({isNew: false});
            }
        });

        jQuery(document).ready(function($) {
            app = new UserListView({
                el: $('#users'),
                collection: new UserList({})
            });
        });
    </script>
    <script src="/js/chatterbird.js"></script>
    <script src="/js/config.js"></script>
    <script type="text/javascript">
        var socket = new Chatterbird('admin');

        socket.onmessage = function(message) {
            app.processData(message.clientsInfo);
        };
    </script>
</head>
<body>
    <ul id="users" class="list"></ul>
</body>
</html>
